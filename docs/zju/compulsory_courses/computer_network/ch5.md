# 5 The Network Layer

!!! tip "说明"

    本文档正在更新中……

!!! info "说明"

    本文档仅涉及部分内容，仅可用于复习重点知识

## 1 Overview of Network Layer

- 网络层：负责将数据包从发送方（源主机）跨越多个网络路由到接收方（目的主机）。它关注的是端到端的通信，可能跨越多个不同的物理网络。IP 协议是这一层的核心
- 数据链路层：负责在同一个本地网络内（例如，同一个以太网、同一个 Wi-Fi 网络内），将帧从一个设备（节点）传送到另一个直接相连的设备。它关注的是单跳通信，即在单一网段或物理链路上的数据传输。可以理解为负责最后一公里（或第一公里）的传输，确保数据在相邻设备间可靠传递

网络层的两个核心功能：

1. **forwarding**（转发）：是路由器在收到一个数据包后所执行的即时动作。它查看数据包的目的地址，查询内部的转发表，然后决定该数据包应该从哪个具体的端口发送出去
2. **routing**（路由）：是决定数据包从源到目的地的整条路径的过程。它通过运行路由协议（如 OSPF, BGP）来收集网络信息，计算最佳路径，并最终生成和更新每个路由器里的转发表

> 路由过程负责生成和更新转发表；而转发过程则使用这张转发表来实际运送每个数据包。简单来说，路由是决策，转发是执行

网络层设计的两个基本出发点：

1. 对传输层的服务：网络层作为传输层的下层，需要为其提供服务。这里的关键设计抉择是提供面向连接的、可靠的虚电路服务（类似于电话系统），还是提供无连接的、尽最大努力交付的数据报服务（类似于邮政系统）。这个选择直接影响上层应用的开发
2. 网络的内部设计：这关乎如何在网络内部实现数据包的传输。是使用虚电路方式（在通信前先建立一条逻辑路径），还是使用数据报方式（每个数据包独立路由）。这个内部设计可以与提供给上层的服务相互独立

store-and-forward packet switching（存储转发式分组交换）：这是网络层（也是早期计算机网络）实现数据转发的基础性机制。其工作流程可以分解为以下步骤：

1. 接收与存储：当路由器从一条输入链路开始接收一个数据包时，它不会立即将正在接收的比特转发出去
2. 完整接收：路由器会等待，直到整个数据包的所有比特都到达，并将其临时存储（缓存） 在内存中
3. 处理与转发：在确认整个数据包已完整无误地到达后（例如，通过 CRC 校验），路由器才会查询其转发表，决定从哪条输出链路发送，然后开始将整个数据包转发到下一个节点

<figure markdown="span">
    ![Img 1](../../../img/computer_network/ch5/network_ch5_img1.png){ width="600" }
</figure>

网络层服务的三个基本原则，其核心思想是简化上层并保持通用性：

1. 独立性：网络层的服务不应该依赖于底层使用的特定路由器品牌或技术。这保证了上层应用能在各种硬件上运行
2. 透明性（屏蔽复杂性）：传输层（以及更上层的应用程序）不应该关心网络底层到底有多少路由器、它们是什么型号、或者它们是如何连接（拓扑）的。网络层负责处理所有这些复杂性，为上层提供一个清晰的抽象接口
3. 寻址一致性：整个网络应该使用一套统一的地址方案（如 IP 地址），这样任何主机都能用同样的方式寻址任何其他主机，无论它们位于网络的哪个位置

!!! tip "面向连接与无连接服务"

    - connection-oriented service：在发送数据之前，必须先通过信令建立一条确定的路径（虚电路）。所有数据包都按顺序沿着这条路径传输，传输结束后拆除连接。优点在于能提供有保证的服务质量
    - connectionless service：每个数据包（数据报）都独立携带完整的目的地址，每个路由器根据当前网络状况为每个包独立选择路径。数据包可能走不同的路径，也可能不按顺序到达。优点是更健壮、更简单、无需建立连接的开销

在无连接服务中，网络层从传输层接收到数据后，会将其封装成独立的 **datagram**（数据报）。每个数据报都包含完整的目的地址。在发送数据之前，不需要像打电话一样先建立一条端到端的路径。每个数据报在网络中都是独立的个体。路由器会为每一个经过的数据报单独进行路由决策，即使它们属于同一个通信流。由于网络状况实时变化，同一源和目的地的不同数据报可能会通过不同的路径传输，从而导致乱序到达

**forwarding table**（转发表）是路由器进行转发决策的路线图。索引键是数据包的目的地址；对应值是为了到达该目的地，应该使用的输出接口或线路

<figure markdown="span">
    ![Img 2](../../../img/computer_network/ch5/network_ch5_img2.png){ width="600" }
</figure>

在面向连接服务中，在通信开始之前，会先建立一条穿越网络的虚电路。这是一条预定义的路径，不同于物理电路，它是逻辑上的。每个数据包不再需要携带完整的目的地地址。取而代之的是，它只携带一个简短的连接标识符（例如，一个虚拟电路号或标签）。这个标识符在每段链路上是局部的，只在两个相邻路由器之间有意义。路由器根据数据包到达的输入接口和包内的标识符，结合其转发表，决定将其从哪个输出接口转发出去，并通常会将标识符替换为下一段链路使用的新的标识符

!!! tip "MPLS（多协议标签交换）"

    MPLS 是一种高性能的隧道技术，在 IP 网络之上提供面向连接的转发
    
    路由器 A 为不同的连接分配不同的标识符，即使这些连接可能使用同一条虚电路。路由器可以根据这些标识符对数据进行不同的优先级处理或路由
    
    <figure markdown="span">
        ![Img 3](../../../img/computer_network/ch5/network_ch5_img3.png){ width="600" }
    </figure>

| | 数据报网络（无连接）| 虚电路网络（面向连接）|
| -- | -- | -- |
| **电路建立** | 不需要 | 必需 |
| **寻址** | 每个数据包都包含完整的源地址和目的地址 | 每个数据包包含一个简短的虚电路(VC)号 |
| **状态信息** | 路由器不保存连接的状态信息 | 每条虚电路都需要在路由器中占用每连接的表项空间 |
| **路由** | 每个数据包被独立路由 | 在虚电路建立时选择路由；所有数据包都遵循此路由 |
| **路由器故障的影响** | 没有影响，除了在故障期间丢失的数据包 | 所有经过故障路由器的虚电路都将被中断 |
| **服务质量** | 困难 | 如果能为每条虚电路预先分配足够的资源，则很容易实现 |
| **拥塞控制** | 困难 | 如果能为每条虚电路预先分配足够的资源，则很容易实现 |

## 2 Routing Algorithms

## 3 The Network Layer in The Internet

## 4 MPLS