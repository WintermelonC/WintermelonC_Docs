# 12 Exception

!!! tip "说明"

    本文档正在更新中……

!!! info "说明"

    本文档仅涉及部分内容，仅可用于复习重点知识

## 1 概念

在 C++ 中，**异常**（Exception） 是一种处理程序运行时错误的机制。通过异常处理，可以将错误检测和错误处理分离，提高程序的健壮性和可维护性。C++ 的异常处理主要依赖于 `try`、`throw` 和 `catch` 关键字

C++ 的异常机制是运行时行为，**运行时错误**（如数组越界、空指针访问、除零错误等）可以通过异常机制捕获，而 **编译错误**（如语法错误、类型不匹配等）发生在编译阶段，不能通过异常机制捕获

1. 异常：程序运行过程中出现的错误或异常情况（如除零、内存分配失败等）
2. 抛出（`throw`）：当检测到异常时，使用 `throw` 抛出异常对象
3. 捕获（`catch`）：使用 `catch` 捕获并处理异常
4. 尝试（`try`）：用 `try` 块包裹可能发生异常的代码

```cpp linenums="1"
#include <iostream>
using namespace std;

int divide(int a, int b) {
    if (b == 0)
        throw "除数不能为0"; // 抛出字符串异常
    return a / b;
}

int main() {
    try {
        cout << divide(10, 0) << endl;
    } catch (const char* msg) {
        cout << "异常捕获: " << msg << endl;
    }
    return 0;
}
```

```cpp linenums="1" title="output"
异常捕获: 除数不能为0
```

注意事项：

1. 析构函数抛出异常会导致程序终止，建议用 `noexcept`
2. 不建议抛出基本类型（如 `int`、`char*`），推荐抛出异常类对象
3. `catch(...)` 可以捕获所有类型的异常，但无法获取具体信息
4. 异常处理会有一定的性能开销，建议只在必要时使用

> `catch(...)` 真的是三个点哦

---

单独使用 `throw;`（不带任何异常对象）只能在 `catch` 块内部使用，表示“重新抛出当前捕获到的异常”

这样可以将异常继续传递给上层调用者，常用于在捕获异常后进行部分处理，然后让异常继续向上传递

```cpp linenums="1"
#include <iostream>
using namespace std;

void func() {
    try {
        throw 123; // 抛出异常
    } catch (int e) {
        cout << "func 捕获到异常: " << e << endl;
        throw; // 重新抛出当前异常
    }
}

int main() {
    try {
        func();
    } catch (int e) {
        cout << "main 再次捕获到异常: " << e << endl;
    }
    return 0;
}
```

```cpp linenums="1" title="output"
func 捕获到异常: 123
main 再次捕获到异常: 123
```

## 2 异常类

C++标准库 `<exception>` 提供了一些常用的异常类，如：

1. `std::exception`：所有标准异常的基类
2. `std::runtime_error`、`std::logic_error` 等

可以自定义异常类型（通常继承自 `std::exception`）

```cpp linenums="1"
#include <iostream>
#include <exception>
using namespace std;

class MyException : public exception {
public:
    const char* what() const noexcept override {
        return "自定义异常";
    }
};

int main() {
    try {
        throw MyException();
    } catch (const exception& e) {
        cout << "捕获异常: " << e.what() << endl;
    }
    return 0;
}
```

## 3 `assert`

在 C++ 中，`assert` 是一个用于 **断言** 的宏，定义在头文件 `<cassert>`（或 C 语言的 `<assert.h>`）中

它的作用是在程序运行时检查某个条件是否为真。如果条件为假，`assert` 会输出错误信息并终止程序执行，帮助开发者在调试阶段发现程序中的逻辑错误

1. 断言的典型用法是：`assert(表达式)`
2. 如果表达式为假，程序会输出类似 `Assertion failed: 表达式, file 文件名, line 行号` 的信息，并终止执行
3. `assert` 主要用于调试阶段，在发布（Release）版本中可通过定义 `NDEBUG` 宏禁用所有断言

```cpp linenums="1"
#include <cassert>
#include <iostream>
using namespace std;

int main() {
    int x = 5;
    assert(x > 0); // 条件为真，程序继续执行

    int y = -1;
    assert(y >= 0); // 条件为假，程序终止并输出错误信息
    cout << "这行不会被执行" << endl;
    return 0;
}
```